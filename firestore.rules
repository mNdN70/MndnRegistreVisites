/**
 * @fileoverview Firestore Security Rules for the visit logging application.
 *
 * Core Philosophy:
 * This ruleset prioritizes secure data access based on a combination of public read access and owner-only write access for `visits` and public read access for `persons_to_visit`.
 *
 * Data Structure:
 * - /persons_to_visit/{personToVisitId}: Stores information about people who can be visited. Publicly readable.
 * - /visits/{visitId}: Stores visit records. Publicly readable but writes are restricted based on ownership.
 *
 * Key Security Decisions:
 * - Users can read all visit and person_to_visit data.
 * - Only the creator of a visit can modify or delete it.  The creator is determined by the `id` and `visitorId` field inside the `Visit` document.
 *
 * Denormalization for Authorization:
 * - The `Visit` entity relies on the `id` and `visitorId` fields to validate ownership. When a new `Visit` document is created the `id` is compared to the user's `auth.uid`.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows anyone to read `PersonToVisit` documents, but only allows creating, updating and deleting by the resource's id.
     * @path /persons_to_visit/{personToVisitId}
     * @allow (get, list) Anyone can read the data.
     * @allow (create) Only the user whose ID matches the document ID can create.
     * @deny (create) If the incoming data does not have all required fields.
     * @allow (update) Only the user whose ID matches the document ID can update.
     * @deny (update) If the update changes the personToVisitId.
     * @allow (delete) Only the user whose ID matches the document ID can delete.
     * @principle Public read access with owner-only writes, enforcing document ownership.
     */
    match /persons_to_visit/{personToVisitId} {
      allow get: if true;
      allow list: if true;

      allow create: if isSignedIn() && request.resource.data.id == personToVisitId;
      allow update: if isSignedIn() && resource.data.id == personToVisitId;
      allow delete: if isSignedIn() && resource.data.id == personToVisitId;
    }

    /**
     * @description Allows anyone to read `Visit` documents, but only allows creating, updating and deleting by the resource's id.
     * @path /visits/{visitId}
     * @allow (get, list) Anyone can read the data.
     * @allow (create) Only the user whose ID matches the document ID can create.
     * @deny (create) If the incoming data does not have all required fields.
     * @allow (update) Only the user whose ID matches the document ID can update.
     * @deny (update) If the update changes the visitId.
     * @allow (delete) Only the user whose ID matches the document ID can delete.
     * @principle Public read access with owner-only writes, enforcing document ownership.
     */
    match /visits/{visitId} {
      allow get: if true;
      allow list: if true;

      allow create: if isSignedIn() && request.resource.data.id == visitId;
      allow update: if isExistingOwner(visitId) && resource.data.id == visitId;
      allow delete: if isExistingOwner(visitId);
    }

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(visitId) {
        return request.auth.uid == visitId;
    }

    function isExistingOwner(visitId) {
        return isOwner(visitId) && resource != null;
    }
  }
}