/**
 * @fileoverview Firestore Security Rules for the visit logging application.
 *
 * Core Philosophy:
 * This ruleset prioritizes secure data access based on a flat data structure.
 * It avoids complex hierarchical lookups for authorization and focuses on
 * explicit ownership and read access control.
 *
 * Data Structure:
 * - /persons_to_visit/{personToVisitId}: Stores information about people who can be visited.
 * - /visits/{visitId}: Stores visit records with details like visitor info, timestamps, and associated person to visit.
 *
 * Key Security Decisions:
 * - The `persons_to_visit` collection has public read access.
 * - Access to the `visits` collection is only allowed to authenticated users. No ownership validation is performed.
 *   Validation of the `visit` data should be improved.
 * - Denormalization of `active` field enables efficient queries for active visits.
 * - User listing is disabled on `visits` to prevent unauthorized data discovery.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Grants public read access to the `persons_to_visit` collection. All authenticated users can create data.
     * @path /persons_to_visit/{personToVisitId}
     * @allow get, list: Anyone can read person to visit data.
     * @allow create: Authenticated users can create person to visit data.
     * @deny update, delete: Updates and deletes are not allowed.
     * @principle Public read access for employee data.
     */
    match /persons_to_visit/{personToVisitId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update, delete: if false;
    }

    /**
     * @description Grants authenticated users access to the `visits` collection.
     * @path /visits/{visitId}
     * @allow get: Authenticated users can get visit data.
     * @allow create: Authenticated users can create visit data.
     * @allow update: Authenticated users can update visit data.
     * @allow delete: Authenticated users can delete visit data.
     * @deny list: Listing visits is not allowed to prevent unauthorized data discovery.
     * @principle Authenticated access to visit records.  Improve ownership validation.
     */
    match /visits/{visitId} {
      allow get: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
      allow list: if false;
    }

    /**
     * @description Checks if the user is signed in.
     * @return {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }
  }
}