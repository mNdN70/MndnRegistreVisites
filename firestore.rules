/**
 * @file Overview
 * This ruleset enforces a user-ownership model for visits, ensuring that only authenticated users can create, read, update, or delete visit records.
 * The `persons_to_visit` collection is publicly readable, while the `visits` collection is secured based on ownership.
 * Data Structure:
 * - /persons_to_visit/{personToVisitId}: Stores information about people to visit. Publicly readable.
 * - /visits/{visitId}: Stores visit records. Secured by ownership.
 *
 * Key Security Decisions:
 * - The `persons_to_visit` collection is publicly readable to allow easy lookup of people to visit.
 * - The `visits` collection enforces strict ownership: only the user who created a visit can modify or delete it.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows anyone to read the list of people to visit, but restricts writes.
     * @path /persons_to_visit/{personToVisitId}
     * @allow (get, list) Anyone can read the data.
     * @deny (create, update, delete) No one can create, update, or delete.
     * @principle Public read-only access for `persons_to_visit`.
     */
    match /persons_to_visit/{personToVisitId} {
      allow get: if true;
      allow list: if true;
    }

    /**
     * @description Enforces ownership for visit records. Only the authenticated user can create, read, update, or delete their own visit records.
     * @path /visits/{visitId}
     * @allow (create) Authenticated user can create a new visit record if `request.auth.uid` is not null.
     * @allow (get, list) Authenticated user can read their own visit records.
     * @allow (update, delete) Authenticated user can update or delete their own existing visit records.
     * @deny (create) If `request.auth.uid` is null.
     * @deny (update, delete) If the visit record does not exist.
     * @deny (update, delete) If the authenticated user is not the owner of the visit record.
     * @principle Enforces document ownership for writes, ensuring only the creator can modify or delete.
     */
    match /visits/{visitId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.visitorId == request.auth.uid;
      allow update: if isSignedIn() && get(/databases/$(database)/documents/visits/$(visitId)).data.visitorId == request.auth.uid;
      allow delete: if isSignedIn() && get(/databases/$(database)/documents/visits/$(visitId)).data.visitorId == request.auth.uid;
    }
    
    /**
     * @description Explicitly deny any write operations for the departments collection,
     * as this operation isn't defined in the App requirements (backend.json).
     * @path /departments/{departmentId}
     * @allow (get, list) No read access granted.
     * @deny (create, update, delete) All write operations are denied.
     * @principle Explicitly deny access where it's not required or defined.
     */
    match /departments/{departmentId} {
      allow get: if false;
      allow list: if false;
    }
  }

  // Helper functions
  function isSignedIn() {
    return request.auth != null;
  }
}