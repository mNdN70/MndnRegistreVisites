/**
 * @fileoverview Firestore Security Rules for the visit logging application.
 *
 * Core Philosophy:
 * This ruleset prioritizes secure data access based on a combination of public read access for specific collections and
 * ownership-based write access.  It is designed for prototyping, so data shape validation is relaxed to allow for rapid iteration.
 *
 * Data Structure:
 * - /persons_to_visit/{personToVisitId}: Stores information about people who can be visited.  Data is considered public.
 * - /visits/{visitId}: Stores visit records.  Read access is public, write access is restricted to authenticated users.
 *
 * Key Security Decisions:
 * - The `persons_to_visit` collection is publicly readable.
 * - The `visits` collection is publicly readable, but write access is only allowed for authenticated users. There is no ownership concept currently defined, any signed-in user can update or delete a visit record.
 * - No listing restrictions are in place besides requiring sign-in where appropriate.
 *
 * Denormalization for Authorization:
 *  N/A - No denormalization is currently required given the access patterns, but this should be revisited as features are added.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows anyone to read the list of people to visit.
     * @path /persons_to_visit/{personToVisitId}
     * @allow (get, list): Any user can read any person to visit.
     * @deny (create, update, delete): No one can create, update, or delete a person to visit.
     * @principle Public data, no write access.
     */
    match /persons_to_visit/{personToVisitId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows anyone to read visit information, but restricts modifications to authenticated users.
     * @path /visits/{visitId}
     * @allow (get, list): Any user can read visit information.
     * @allow (create): Any signed-in user can create a visit.
     * @allow (update): Any signed-in user can update a visit if the document exists.
     * @allow (delete): Any signed-in user can delete a visit if the document exists.
     * @deny (create): Create requests without authentication.
     * @deny (update, delete): Update/delete requests without authentication or if the document does not exist.
     * @principle Public read access with authenticated write access.
     */
    match /visits/{visitId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    function isSignedIn() {
      return request.auth != null;
    }
  }
}